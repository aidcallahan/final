<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drought Awareness</title>

    <!-- Leaflet.js (for the map) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }

        h1 {
            text-align: left;
            padding-top: 20px;
            padding-left: 20px;
        }

        form {
            text-align: center;
            margin: 20px;
        }

        label, select, input {
            margin: 10px;
        }

        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        #advice {
            text-align: center;
            margin-top: 20px;
            font-size: 18px;
        }

        #map {
            height: 500px;
            width: 100%;
        }
    </style>
</head>
<body>

    <h1>Check if Your Area is in Drought (2024)</h1>
    <form id="locationForm">
        <label for="address">Enter your address:</label>
        <input type="text" id="address" name="address" required>

        <label for="month">Select month:</label>
        <select id="month" name="month" required>
            <option value="1">January</option>
            <option value="2">February</option>
            <option value="3">March</option>
            <option value="4">April</option>
            <option value="5">May</option>
            <option value="6">June</option>
            <option value="7">July</option>
            <option value="8">August</option>
            <option value="9">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
        </select>
        
        <button type="submit">Check Drought Status</button>
    </form>

    <div id="map"></div> <!-- Map container -->
    <div id="advice"></div> <!-- Water preservation advice -->

    <script>
        let map; // Declare the map variable outside of the function to ensure global access

        // List of GeoJSON files corresponding to each month
        const droughtDataUrls = {
            1: 'https://raw.githubusercontent.com/aidcallahan/final/main/data/usdm_20240102.json',
            2: 'https://raw.githubusercontent.com/aidcallahan/final/main/data/usdm_20240206.json',
            3: 'https://raw.githubusercontent.com/aidcallahan/final/main/data/usdm_20240305.json',
            4: 'https://raw.githubusercontent.com/aidcallahan/final/main/data/usdm_20240402.json',
            5: 'https://raw.githubusercontent.com/aidcallahan/final/main/data/usdm_20240507.json',
            6: 'https://raw.githubusercontent.com/aidcallahan/final/main/data/usdm_20240604.json',
            7: 'https://raw.githubusercontent.com/aidcallahan/final/main/data/usdm_20240702.json',
            8: 'https://raw.githubusercontent.com/aidcallahan/final/main/data/usdm_20240806.json',
            9: 'https://raw.githubusercontent.com/aidcallahan/final/main/data/usdm_20240903.json',
            10: 'https://raw.githubusercontent.com/aidcallahan/final/main/data/usdm_20241001.json',
            11: 'https://raw.githubusercontent.com/aidcallahan/final/main/data/usdm_20241105.json',
            12: 'https://raw.githubusercontent.com/aidcallahan/final/main/data/usdm_20241203.json'
        };

        // Submit event listener for the location form
        document.getElementById('locationForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const address = document.getElementById('address').value;
            const month = parseInt(document.getElementById('month').value);

            // Geocode the address using Nominatim (OpenStreetMap)
            getCoordinates(address).then(coords => {
                console.log("Geocoded coordinates:", coords); // Debugging: log the coordinates
                if (coords.lat && coords.lon) {
                    const lat = coords.lat;
                    const lon = coords.lon;

                    // Fetch the drought data for the selected month
                    getDroughtData(month, lat, lon).then(droughtData => {
                        // Display the map with drought heatmap
                        showMap(lat, lon, droughtData);

                        // Show advice based on drought data
                        displayAdvice(droughtData);
                    }).catch(error => {
                        console.error('Error fetching drought data:', error);
                    });
                } else {
                    console.error('Invalid coordinates received!');
                }
            }).catch(error => {
                console.error('Error fetching coordinates:', error);
                alert('Unable to find the coordinates for the given address.');
            });
        });

        // Function to geocode address using Nominatim (OpenStreetMap)
        function getCoordinates(address) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&addressdetails=1&limit=1`;

            return fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const result = data[0];
                        return {
                            lat: parseFloat(result.lat),
                            lon: parseFloat(result.lon)
                        };
                    } else {
                        throw new Error('No results found for the provided address');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    return { lat: null, lon: null };
                });
        }

        // Function to fetch drought data for the selected month from GitHub
        function getDroughtData(month, lat, lon) {
            const droughtDataUrl = droughtDataUrls[month];

            return fetch(droughtDataUrl)
                .then(response => response.json())
                .then(data => {
                    return findDroughtSeverity(data, lat, lon);
                })
                .catch(error => {
                    console.error('Error fetching drought data:', error);
                    return 'Normal'; // Default to Normal if there's an issue
                });
        }

        // Function to find drought severity based on the fetched data
        function findDroughtSeverity(droughtData, lat, lon) {
            let severity = 'Normal';  // Default to Normal

            if (lat && lon) { // Check if lat and lon are defined
                console.log("Features in drought data:", droughtData.features); // Log all features

                droughtData.features.forEach(feature => {
                    console.log("Checking feature: ", feature); // Debugging: log each feature
                    console.log("Feature geometry:", feature.geometry); // Log geometry to ensure we are looking at the correct data
                    console.log("Feature coordinates:", feature.geometry.coordinates); // Log coordinates
                    
                    // Check if the coordinates are within the bounds of the drought region
                    if (isInside(lat, lon, feature.geometry.coordinates)) {
                        console.log("Found a match inside polygon! Drought type: ", feature.properties.DM);
                        
                        // Map DM values to severity
                        switch (feature.properties.DM) {
                            case 1:
                                severity = 'Abnormally Dry';
                                break;
                            case 2:
                                severity = 'Drought';
                                break;
                            case 3:
                                severity = 'Severe Drought';
                                break;
                            case 4:
                                severity = 'Extreme Drought'; // Added DM=4 for extreme drought
                                break;
                            default:
                                severity = 'Normal'; // Default to Normal if not matching 1, 2, 3, or 4
                        }
                    }
                });
            } else {
                console.error("Latitude or Longitude is undefined!");
            }
            return severity;
        }

        // Function to check if a point is inside a polygon (supports both single and multi-polygons)
        function isInside(lat, lon, coordinates) {
            let inside = false;
            console.log("Checking point (" + lat + ", " + lon + ") against polygon");

            // Handle MultiPolygon (array of polygons)
            if (Array.isArray(coordinates[0][0])) {
                coordinates.forEach(polygon => {
                    inside = inside || checkPolygonInside(lon, lat, polygon); // Swap lat and lon here
                });
            } else {
                // Single polygon
                inside = checkPolygonInside(lon, lat, coordinates); // Swap lat and lon here
            }

            console.log("Inside polygon? " + inside);
            return inside;
        }

        // Helper function to check if a point is inside a single polygon using Ray-Casting Algorithm
        function checkPolygonInside(lon, lat, polygon) {
            let inside = false;
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                let xi = polygon[i][0], yi = polygon[i][1]; // [longitude, latitude]
                let xj = polygon[j][0], yj = polygon[j][1]; // [longitude, latitude]

                // Ray-Casting algorithm check
                let intersect = ((yi > lat) !== (yj > lat)) && (lon < (xj - xi) * (lat - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            return inside;
        }

        // Function to show the map with drought severity circles
        function showMap(lat, lon, droughtData) {
            if (map) {
                map.remove(); // Remove the existing map
            }

            map = L.map('map').setView([lat, lon], 10);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            const severityColors = {
                'Normal': 'green',
                'Abnormally Dry': 'yellow',
                'Drought': 'orange',
                'Severe Drought': 'red',
                'Extreme Drought': 'purple' // Color for DM=4
            };

            // Add a circle marker at the address location
            L.circle([lat, lon], {
                color: severityColors[droughtData] || 'green', // Default to green
                radius: 10000, // 10 km radius
                fillOpacity: 0.5
            }).addTo(map).bindPopup(`Drought Severity: ${droughtData}`);
        }

        // Function to display water preservation advice
        function displayAdvice(severity) {
            const advice = document.getElementById('advice');
            let message = '';

            switch (severity) {
                case 'Normal':
                    message = "<b>Normal</b>: Business as usual. Continue to conserve water where possible.";
                    break;
                case 'Abnormally Dry':
                    message = "<b>Abnormally Dry</b>: Consider using water more efficiently. Limit outdoor watering.";
                    break;
                case 'Drought':
                    message = "<b>Drought</b>: Be mindful of water usage. Conserve water and avoid wasteful practices.";
                    break;
                case 'Severe Drought':
                    message = "<b>Severe Drought</b>: Water restrictions may be in place. Conserve water as much as possible.";
                    break;
                case 'Extreme Drought':
                    message = "<b>Extreme Drought</b>: Extreme drought conditions. Strict water-saving measures are mandatory.";
                    break;
                default:
                    message = 'Unable to determine drought severity.';
                    break;
            }
            advice.innerHTML = message;
        }
    </script>

</body>
</html>
