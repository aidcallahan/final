<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drought Awareness</title>

    <!-- Leaflet.js (for the map) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }

        h1 {
            text-align: left;
            padding-top: 20px;
            padding-left: 20px;
        }

        form {
            text-align: center;
            margin: 20px;
        }

        label, select, input {
            margin: 10px;
        }

        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        #advice {
            text-align: center;
            margin-top: 20px;
            font-size: 18px;
        }

        #map {
            height: 500px;
            width: 100%;
        }
    </style>
</head>
<body>

    <h1>Check if Your Area is in Drought (2024)</h1>
    <form id="locationForm">
        <label for="address">Enter your address:</label>
        <input type="text" id="address" name="address" required>

        <label for="month">Select month:</label>
        <select id="month" name="month" required>
            <option value="1">January</option>
            <option value="2">February</option>
            <option value="3">March</option>
            <option value="4">April</option>
            <option value="5">May</option>
            <option value="6">June</option>
            <option value="7">July</option>
            <option value="8">August</option>
            <option value="9">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
        </select>
        
        <button type="submit">Check Drought Status</button>
    </form>

    <div id="map"></div> <!-- Map container -->
    <div id="advice"></div> <!-- Water preservation advice -->

    <script>
        let map; // Declare the map variable outside of the function to ensure global access

        // List of GeoJSON files corresponding to each month
        const droughtDataUrls = {
            1: 'https://raw.githubusercontent.com/aidcallahan/final/main/data/usdm_20240102.json',
            2: 'https://raw.githubusercontent.com/aidcallahan/final/main/data/usdm_20240206.json',
            3: 'https://raw.githubusercontent.com/aidcallahan/final/main/data/usdm_20240305.json',
            4: 'https://raw.githubusercontent.com/aidcallahan/final/main/data/usdm_20240402.json',
            5: 'https://raw.githubusercontent.com/aidcallahan/final/main/data/usdm_20240507.json',
            6: 'https://raw.githubusercontent.com/aidcallahan/final/main/data/usdm_20240604.json',
            7: 'https://raw.githubusercontent.com/aidcallahan/final/main/data/usdm_20240702.json',
            8: 'https://raw.githubusercontent.com/aidcallahan/final/main/data/usdm_20240806.json',
            9: 'https://raw.githubusercontent.com/aidcallahan/final/main/data/usdm_20240903.json',
            10: 'https://raw.githubusercontent.com/aidcallahan/final/main/data/usdm_20241001.json',
            11: 'https://raw.githubusercontent.com/aidcallahan/final/main/data/usdm_20241105.json',
            12: 'https://raw.githubusercontent.com/aidcallahan/final/main/data/usdm_20241203.json'
        };

        // Submit event listener for the location form
        document.getElementById('locationForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const address = document.getElementById('address').value;
            const month = parseInt(document.getElementById('month').value);

            // Geocode the address using Nominatim (OpenStreetMap)
            getCoordinates(address).then(coords => {
                if (coords.lat && coords.lon) {
                    const lat = coords.lat;
                    const lon = coords.lon;

                    // Fetch the drought data for the selected month
                    getDroughtData(month).then(droughtData => {
                        // Display the map with drought heatmap
                        showMap(lat, lon, droughtData);

                        // Show advice based on drought data
                        displayAdvice(droughtData);
                    }).catch(error => {
                        console.error('Error fetching drought data:', error);
                    });
                }
            }).catch(error => {
                console.error('Error fetching coordinates:', error);
                alert('Unable to find the coordinates for the given address.');
            });
        });

        // Function to geocode address using Nominatim (OpenStreetMap)
        function getCoordinates(address) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&addressdetails=1&limit=1`;

            return fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const result = data[0];
                        return {
                            lat: parseFloat(result.lat),
                            lon: parseFloat(result.lon)
                        };
                    } else {
                        throw new Error('No results found for the provided address');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    return { lat: null, lon: null };
                });
        }

        // Function to fetch drought data for the selected month from GitHub
        function getDroughtData(month) {
            const droughtDataUrl = droughtDataUrls[month];

            return fetch(droughtDataUrl)
                .then(response => response.json())
                .then(data => {
                    return findDroughtSeverity(data);
                })
                .catch(error => {
                    console.error('Error fetching drought data:', error);
                    return 'Normal'; // Default to Normal if there's an issue
                });
        }

        // Function to find drought severity based on the fetched data
        function findDroughtSeverity(droughtData) {
            let severity = 'Normal';  // Default to Normal
            droughtData.features.forEach(feature => {
                // Check if the coordinates are within the bounds of the drought region
                if (isInside(lat, lon, feature.geometry.coordinates[0])) {
                    severity = feature.properties.Drought_Type || 'Normal';
                }
            });
            return severity;
        }

        // Function to check if a point is inside a polygon
        function isInside(lat, lon, bounds) {
            let inside = false;
            for (let i = 0, j = bounds.length - 1; i < bounds.length; j = i++) {
                let xi = bounds[i][0], yi = bounds[i][1];
                let xj = bounds[j][0], yj = bounds[j][1];

                let intersect = ((yi > lat) !== (yj > lat)) && (lon < (xj - xi) * (lat - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            return inside;
        }

        // Function to show the map with drought severity circles
        function showMap(lat, lon, droughtData) {
            if (map) {
                map.remove(); // Remove the existing map
            }

            map = L.map('map').setView([lat, lon], 10);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            const droughtLayer = L.layerGroup().addTo(map);
            if (droughtData === 'Extreme') {
                L.circle([lat, lon], { color: 'red', radius: 50000 }).addTo(droughtLayer).bindPopup('Extreme Drought');
            } else if (droughtData === 'Moderate') {
                L.circle([lat, lon], { color: 'orange', radius: 50000 }).addTo(droughtLayer).bindPopup('Moderate Drought');
            } else {
                L.circle([lat, lon], { color: 'green', radius: 50000 }).addTo(droughtLayer).bindPopup('Normal Conditions');
            }
        }

        // Function to display advice based on drought severity
        function displayAdvice(droughtData) {
            const adviceElement = document.getElementById('advice');
            if (droughtData === 'Extreme') {
                adviceElement.innerHTML = "<strong>Extreme Water Preservation Required:</strong> Avoid water-intensive activities, reduce outdoor water usage, and follow local water restrictions.";
            } else if (droughtData === 'Moderate') {
                adviceElement.innerHTML = "<strong>Moderate Water Preservation:</strong> Be mindful of water use, limit lawn watering, and reduce water waste.";
            } else {
                adviceElement.innerHTML = "<strong>Normal Conditions:</strong> No special water preservation practices are needed.";
            }
        }
    </script>
</body>
</html>
